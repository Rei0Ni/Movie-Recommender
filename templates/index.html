<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieBot</title>

    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
          darkMode: 'class', // now Tailwind will use the “class” strategy
        };
    </script>

    <link rel="stylesheet" href="../static/styles.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen p-6 transition-colors duration-300 relative">
    <div class="w-full h-full min-h-full bg-white dark:bg-gray-800 rounded-lg shadow-md p-2 sm:p-4 md:p-6 space-y-4 sm:space-y-6 transition-colors duration-300 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 dark:text-gray-100 mb-2 sm:mb-4 transition-colors duration-300">
                Movie Recommender Bot
            </h1>
            <div class="flex items-center">

                <svg class="w-6 h-6 mr-2 text-yellow-500 block dark:hidden" version="1.0" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 64 64" enable-background="new 0 0 64 64" xml:space="preserve" fill="#F5C525" stroke="#F5C525">
                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                    <g id="SVGRepo_iconCarrier"> 
                        <g> 
                            <circle fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" cx="32.003" cy="32.005" r="16.001"></circle> 
                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" d="M12.001,31.997c0-2.211-1.789-4-4-4H4c-2.211,0-4,1.789-4,4 s1.789,4,4,4h4C10.212,35.997,12.001,34.208,12.001,31.997z"></path> 
                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" d="M12.204,46.139l-2.832,2.833c-1.563,1.562-1.563,4.094,0,5.656 c1.562,1.562,4.094,1.562,5.657,0l2.833-2.832c1.562-1.562,1.562-4.095,0-5.657C16.298,44.576,13.767,44.576,12.204,46.139z"></path> 
                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" d="M32.003,51.999c-2.211,0-4,1.789-4,4V60c0,2.211,1.789,4,4,4 s4-1.789,4-4l-0.004-4.001C36.003,53.788,34.21,51.999,32.003,51.999z"></path> 
                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" d="M51.798,46.143c-1.559-1.566-4.091-1.566-5.653-0.004 s-1.562,4.095,0,5.657l2.829,2.828c1.562,1.57,4.094,1.562,5.656,0s1.566-4.09,0-5.656L51.798,46.143z"></path> 
                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" d="M60.006,27.997l-4.009,0.008 c-2.203-0.008-3.992,1.781-3.992,3.992c-0.008,2.211,1.789,4,3.992,4h4.001c2.219,0.008,4-1.789,4-4 C64.002,29.79,62.217,27.997,60.006,27.997z"></path> 
                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" d="M51.798,17.859l2.828-2.829c1.574-1.566,1.562-4.094,0-5.657 c-1.559-1.567-4.09-1.567-5.652-0.004l-2.829,2.836c-1.562,1.555-1.562,4.086,0,5.649C47.699,19.426,50.239,19.418,51.798,17.859z"></path> 
                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" d="M32.003,11.995c2.207,0.016,4-1.789,4-3.992v-4 c0-2.219-1.789-4-4-4c-2.211-0.008-4,1.781-4,3.993l0.008,4.008C28.003,10.206,29.792,11.995,32.003,11.995z"></path> 
                            <path fill-rule="evenodd" clip-rule="evenodd" fill="#F5C525" d="M12.212,17.855c1.555,1.562,4.079,1.562,5.646-0.004 c1.574-1.551,1.566-4.09,0.008-5.649l-2.829-2.828c-1.57-1.571-4.094-1.559-5.657,0c-1.575,1.559-1.575,4.09-0.012,5.653 L12.212,17.855z"></path> 
                        </g> 
                    </g>
                </svg>

                <svg class="w-6 h-6 mr-2 text-gray-700 dark:text-gray-300 hidden dark:block" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                </svg>

                <input type="checkbox" id="darkModeToggle" class="hidden peer">
                <label for="darkModeToggle"
                       class="flex items-center cursor-pointer w-12 h-6 rounded-full
                              bg-gray-300 dark:bg-gray-600 transition-colors duration-300
                              relative p-0.5">
                    <span class="sr-only">Toggle Dark Mode</span>
                    <div class="toggle-circle absolute w-5 h-5 bg-white rounded-full shadow
                                peer-checked:bg-blue-500 transition-all duration-300">
                    </div>
                </label>
            </div>
        </div>
        

        <div id="chat_box"
            class="min-h-[24rem] sm:min-h-[22rem] md:min-h-[22rem] lg:min-h-[22rem] xl:min-h-[22rem] border border-gray-200 dark:border-gray-700 rounded-md p-2 sm:p-4 overflow-y-auto space-y-3 sm:space-y-4 bg-gray-50 dark:bg-gray-700 transition-colors duration-300 flex-1 min-h-0 max-h-[24rem] sm:max-h-[22rem] md:max-h-[22rem] lg:max-h-[22rem] xl:max-h-[22rem]">
            <div class="flex justify-start">
               <div class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-3 py-2 rounded-lg
                        max-w-[90vw] sm:max-w-xs lg:max-w-md break-words transition-colors duration-300 text-sm sm:text-base">
                  Hi there! How can I help you find a movie? Try 'Suggest a good action movie in English with ratings above 7 after 2010' or 'Recommend horror films before 1990'.
               </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-2 sm:gap-0">
            <input type="text" id="user_input" placeholder="Ask for Movie Recommendations..."
                   class="flex-grow p-3 border border-gray-300 dark:border-gray-600 rounded-md sm:rounded-l-md sm:rounded-r-none
                          focus:outline-none focus:ring-0
                          bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100
                          placeholder-gray-500 dark:placeholder-gray-400
                          transition-colors duration-300 text-base"
                   onkeydown="handleKeyDown(event)" />
            <button onclick="sendMessage()"
                    class="bg-blue-500 dark:bg-blue-700 text-white font-semibold px-5 py-3 rounded-md sm:rounded-r-md sm:rounded-l-none
                           hover:bg-blue-600 dark:hover:bg-blue-600
                           focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-600 focus:ring-offset-1
                           whitespace-nowrap transition-colors duration-300 text-base">
                Send
            </button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById("chat_box");
        const userInput = document.getElementById("user_input");
        const darkModeToggle = document.getElementById('darkModeToggle');
        const root = document.documentElement; // Target the html element

        // --- Dark Mode Toggle Logic ---
        // Check local storage for saved theme preference on load
        const savedTheme = localStorage.getItem('theme');

        // Apply saved theme, default to light if no preference
        if (savedTheme === 'dark') {
            root.classList.add('dark'); // Apply dark class to html
            darkModeToggle.checked = true; // Check the toggle switch visually
        } else {
            root.classList.remove('dark'); // Ensure dark class is removed
            darkModeToggle.checked = false; // Ensure the toggle is unchecked visually
             // If savedTheme was null or 'light', save 'light' explicitly to ensure consistency
            if (savedTheme !== 'dark') {
                 localStorage.setItem('theme', 'light');
            }
        }

        // Add event listener to the toggle SWITCH (checkbox)
        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                root.classList.add('dark'); // Apply dark class to html
                localStorage.setItem('theme', 'dark');
            } else {
                root.classList.remove('dark'); // Remove dark class from html
                localStorage.setItem('theme', 'light');
            }
        });
        // --- End Dark Mode Toggle Logic ---


        // appendMessage handles both user and bot messages, applying dark mode styles dynamically
        function appendMessage(sender, responseData, isUser) {
            const messageDiv = document.createElement('div');
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'px-4 py-2 rounded-lg max-w-xs break-words';
            if (!isUser) {
                 bubbleDiv.classList.add('lg:max-w-md');
                 bubbleDiv.style.maxWidth = '90%';
            }

            if (isUser) {
                messageDiv.className = 'flex justify-end mb-2';
                bubbleDiv.classList.add('bg-blue-500', 'dark:bg-blue-700', 'text-white');
                bubbleDiv.textContent = responseData; // Use textContent for user input
            } else {
                messageDiv.className = 'flex justify-start mb-2';
                bubbleDiv.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
                bubbleDiv.style.maxWidth = '90%';

                const recommendations = responseData.recommendations;
                const note = responseData.note;

                if (recommendations && recommendations.length > 0) {
                     const ul = document.createElement('ul');
                     ul.className = 'list-none pl-0 space-y-4';

                     const IMAGE_BASE_URL = "https://image.tmdb.org/t/p/";
                     const IMAGE_SIZE = "w185";
                     const TMDB_MOVIE_URL = "https://www.themoviedb.org/movie/";

                     recommendations.forEach(movie => {
                         const movieId = movie.id;
                         const name = movie.name || 'N/A';
                         const year = movie.year || 'N/A';
                         const rating = movie.rating || 'N/A';
                         const genres = movie.genres || 'N/A';
                         const posterPath = movie.poster_path;
                         const overview = movie.overview || 'No overview available.'; // Extract overview

                         const li = document.createElement('li');
                         li.className = 'clearfix border-b border-gray-300 dark:border-gray-500 pb-4 last:border-b-0 last:pb-0 transition-colors duration-300';

                         let imageHtml = '';
                         if (posterPath) {
                             const imageUrl = IMAGE_BASE_URL + IMAGE_SIZE + posterPath;
                             imageHtml = `<img src="${imageUrl}" alt="${name} poster" class="w-16 h-auto rounded-md shadow-sm mr-3 mb-2 float-left">`;
                         }

                         const movieUrl = movieId ? `${TMDB_MOVIE_URL}${movieId}` : null;

                         let titleHtml;
                         if (movieUrl) {
                             titleHtml = `<a href="${movieUrl}" target="_blank"
                                            class="font-bold text-indigo-700 dark:text-indigo-400
                                                   no-underline hover:underline transition-colors duration-300">
                                            ${name}
                                          </a>`;
                         } else {
                             titleHtml = `<span class="font-bold text-gray-800 dark:text-gray-100">${name}</span>`;
                         }

                         // Build the inner HTML content for the list item
                         li.innerHTML = `
                             ${imageHtml}
                             <div class="overflow-hidden">
                                 ${titleHtml} (${year})<br>
                                 <span class="inline-block bg-yellow-200 dark:bg-yellow-700 text-yellow-800 dark:text-yellow-200 text-xs font-semibold px-2 py-0.5 rounded mr-2 mt-1 transition-colors duration-300">Rating: ${rating}</span><br>
                                 <span class="text-xs text-gray-500 dark:text-gray-400 block mt-1 transition-colors duration-300">Genres: ${genres}</span>
                                 ${overview ? `<p class="text-md text-gray-600 dark:text-gray-400 italic mt-2">${overview}</p>` : ''} </div>
                         `;
                         ul.appendChild(li); // Append the list item to the unordered list
                     });
                     bubbleDiv.appendChild(ul); // Append the completed unordered list to the bubble

                     if (note) {
                         const notePara = document.createElement('p');
                         notePara.className = 'text-xs text-gray-500 dark:text-gray-400 italic mt-2 transition-colors duration-300';
                         notePara.textContent = note;
                         bubbleDiv.appendChild(notePara);
                     }

                 } else if (note) {
                      bubbleDiv.innerHTML = note.replace(/\n/g, '<br>');
                 } else {
                     console.error("Received unexpected empty or missing response data:", responseData);
                     bubbleDiv.innerHTML = "Could not process the response from the server.";
                 }
            }
            messageDiv.appendChild(bubbleDiv);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendMessage() {
            const msg = userInput.value.trim();
            if (!msg) return;
            appendMessage("You", msg, true);
            userInput.value = '';
            fetch(`/get?msg=${encodeURIComponent(msg)}`)
                .then(res => {
                    if (!res.ok) {
                         console.error(`HTTP error! status: ${res.status}`);
                         return res.text().then(text => { throw new Error(`HTTP error! status: ${res.status}, body: ${text}`) });
                    }
                    return res.json();
                })
                .then(data => {
                    if (data && data.response) {
                        appendMessage("Bot", data.response, false);
                    } else {
                         appendMessage("Bot", { recommendations: [], note: "Received unexpected response from the server." }, false);
                    }
                })
                .catch(error => {
                    console.error("Error fetching or processing bot response:", error);
                    appendMessage("Bot", { recommendations: [], note: "Sorry, I encountered an error. Please try again." }, false);
                });
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter') sendMessage();
        }
    </script>
</body>
</html>